getgenv().player = game.Players.LocalPlayer
getgenv().runService = game:GetService("RunService")
getgenv().tweenService = game:GetService("TweenService")
getgenv().bringEnabled = false
getgenv().tpEnabled = false
getgenv().bringLoop = nil
getgenv().tpLoop = nil
getgenv().ToggleStop = false
getgenv().ToggleClaim = false
getgenv().Players = game:GetService("Players")
getgenv().ReplicatedStorage = game:GetService("ReplicatedStorage")
getgenv().GuiService = game:GetService("GuiService")
getgenv().VirtualInputManager = game:GetService("VirtualInputManager")

getgenv().getGwaMachine = function()
    return workspace:FindFirstChild("NPC") and 
           workspace.NPC:FindFirstChild("GwaMeachine") and 
           workspace.NPC.GwaMeachine:FindFirstChild("Handle")
end

getgenv().getStatus = function()
    local gwaMachine = getgenv().getGwaMachine()
    if gwaMachine then
        local billboardGui = gwaMachine:FindFirstChild("UI") and gwaMachine.UI:FindFirstChild("Name")
        local statusLabel = billboardGui and billboardGui:FindFirstChild("Status")
        return statusLabel and statusLabel:IsA("TextLabel") and statusLabel.Text or nil
    end
end

getgenv().stopMiner = function()
    while getgenv().ToggleStop do
        if getgenv().getStatus() == "Finished" then
            getgenv().ReplicatedStorage.Networks.ServerF:InvokeServer({{"StopLunarisMiner"}})
        end
        task.wait(1)
    end
end

getgenv().autoClaim = function()
    while getgenv().ToggleClaim do
        if getgenv().getStatus() == "Finished" then
            local playerGui = getgenv().Players.LocalPlayer:FindFirstChild("PlayerGui")
            local machineMain = playerGui and playerGui:FindFirstChild("Main") and 
                                playerGui.Main.Windows:FindFirstChild("MachineMain")
            if machineMain then
                machineMain.Visible = true
                local claimButton = machineMain:FindFirstChild("Lunaris") and 
                                    machineMain.Lunaris.Running.Claim:FindFirstChild("TextButton")
                if claimButton then
                    getgenv().GuiService.SelectedObject = claimButton
                    task.wait(0.1)
                    getgenv().VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                    task.wait(0.1)
                    getgenv().VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                end
            end
        end
        task.wait(1)
    end
end

getgenv().getHumanoidRootPart = function()
    local character = getgenv().player.Character or getgenv().player.CharacterAdded:Wait()
    return character:FindFirstChild("HumanoidRootPart")
end

getgenv().activateProximityPrompt = function(object)
    for _, proximityPrompt in pairs(object:GetDescendants()) do
        if proximityPrompt:IsA("ProximityPrompt") then
            fireproximityprompt(proximityPrompt)
        end
    end
end

getgenv().bringObjectsToPlayer = function()
    local humanoidRootPart = getgenv().getHumanoidRootPart()
    if humanoidRootPart then
        for _, obj in pairs(workspace.Items:GetChildren()) do
            if obj:IsA("MeshPart") and obj:FindFirstChild("Attachment") then
                local targetCFrame = humanoidRootPart.CFrame * CFrame.new(0, 9, 0)
                local tweenInfo = TweenInfo.new(00.01, Enum.EasingStyle.Linear, Enum.EasingDirection.In)
                local tween = getgenv().tweenService:Create(obj, tweenInfo, {CFrame = targetCFrame})
                tween:Play()
                tween.Completed:Wait()
                getgenv().activateProximityPrompt(obj)
            end
        end
    end
end

getgenv().teleportToObjects = function()
    local humanoidRootPart = getgenv().getHumanoidRootPart()
    if humanoidRootPart then
        for _, obj in pairs(workspace.Items:GetChildren()) do
            if obj:IsA("MeshPart") and obj:FindFirstChild("Attachment") then
                local targetCFrame = obj.CFrame * CFrame.new(0, 4, 0)
                local tweenInfo = TweenInfo.new(00.01, Enum.EasingStyle.Linear, Enum.EasingDirection.In)
                local tween = getgenv().tweenService:Create(humanoidRootPart, tweenInfo, {CFrame = targetCFrame})
                tween:Play()
                tween.Completed:Wait()
                getgenv().activateProximityPrompt(obj)
            end
        end
    end
end
