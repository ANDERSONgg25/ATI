getgenv().player = game.Players.LocalPlayer
getgenv().runService = game:GetService("RunService")
getgenv().tweenService = game:GetService("TweenService")
getgenv().Players = game:GetService("Players")
getgenv().ReplicatedStorage = game:GetService("ReplicatedStorage")
getgenv().GuiService = game:GetService("GuiService")
getgenv().VirtualInputManager = game:GetService("VirtualInputManager")
getgenv().UserInputService = game:GetService("UserInputService")

getgenv().bringEnabled = false
getgenv().tpEnabled = false
getgenv().ToggleClaim = false
getgenv().AntiBug = false

getgenv().playerGui = getgenv().player:FindFirstChild("PlayerGui")
if getgenv().playerGui then
    getgenv().machineMain = getgenv().playerGui:FindFirstChild("Main") and getgenv().playerGui.Main.Windows:FindFirstChild("MachineMain")
    if getgenv().machineMain then
        getgenv().gwaRoll = getgenv().machineMain:FindFirstChild("GwaRoll")
        getgenv().lunaris = getgenv().machineMain:FindFirstChild("Lunaris")

        if getgenv().gwaRoll then getgenv().gwaRoll.Visible = false end
        if getgenv().lunaris then getgenv().lunaris.Visible = true end
    end
end

getgenv().toggleAntiBugs = function(value)
    getgenv().AntiBug = value
    while getgenv().AntiBug do
        if getgenv().machineMain then
            if getgenv().lunaris then getgenv().lunaris.Visible = true end
            if getgenv().gwaRoll then getgenv().gwaRoll.Visible = false end
        end
        task.wait(0.5)
    end
end

getgenv().getGwaMachine = function()
    return workspace:FindFirstChild("NPC") and workspace.NPC:FindFirstChild("GwaMeachine") and workspace.NPC.GwaMeachine:FindFirstChild("Handle")
end

getgenv().getStatus = function()
    local gwaMachine = getgenv().getGwaMachine()
    if gwaMachine then
        local statusLabel = gwaMachine:FindFirstChild("UI") and gwaMachine.UI:FindFirstChild("Name") and gwaMachine.UI.Name:FindFirstChild("Status")
        return statusLabel and statusLabel:IsA("TextLabel") and statusLabel.Text or nil
    end
end

getgenv().autoClaim = function()
    while getgenv().ToggleClaim do
        if getgenv().getStatus() == "Finished" and getgenv().machineMain then
            local claimButton = getgenv().lunaris and getgenv().lunaris.Running and getgenv().lunaris.Running:FindFirstChild("Claim") and getgenv().lunaris.Running.Claim:FindFirstChild("TextButton")
            if claimButton then
                getgenv().GuiService.SelectedObject = claimButton
                getgenv().VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                getgenv().VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
            end
        end
        task.wait(0.5)
    end
end

getgenv().getHumanoidRootPart = function()
    local character = getgenv().player.Character or getgenv().player.CharacterAdded:Wait()
    return character and character:FindFirstChild("HumanoidRootPart")
end

getgenv().activateProximityPrompt = function(object)
    for _, proximityPrompt in ipairs(object:GetDescendants()) do
        if proximityPrompt:IsA("ProximityPrompt") then
            fireproximityprompt(proximityPrompt)
        end
    end
end

getgenv().bringObjectsToPlayer = function()
    local humanoidRootPart = getgenv().getHumanoidRootPart()
    if humanoidRootPart then
        for _, obj in ipairs(workspace.Items:GetChildren()) do
            if obj:IsA("MeshPart") and obj:FindFirstChild("Attachment") then
                local targetCFrame = humanoidRootPart.CFrame * CFrame.new(0, 9, 0)
                local tween = getgenv().tweenService:Create(obj, TweenInfo.new(0.01, Enum.EasingStyle.Linear, Enum.EasingDirection.In), {CFrame = targetCFrame})
                tween:Play()
                tween.Completed:Wait()
                getgenv().activateProximityPrompt(obj)
            end
        end
    end
end

getgenv().teleportToObjects = function()
    local humanoidRootPart = getgenv().getHumanoidRootPart()
    if humanoidRootPart then
        for _, obj in ipairs(workspace.Items:GetChildren()) do
            if obj:IsA("MeshPart") and obj:FindFirstChild("Attachment") then
                local targetCFrame = obj.CFrame * CFrame.new(0, 4, 0)

                local bodyPosition = Instance.new("BodyPosition", humanoidRootPart)
                bodyPosition.Position = targetCFrame.Position
                bodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                bodyPosition.D = 10
                bodyPosition.P = 30000

                local tween = getgenv().tweenService:Create(humanoidRootPart, TweenInfo.new(math.huge, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {CFrame = targetCFrame})
                tween:Play()
                tween.Completed:Wait()

                getgenv().activateProximityPrompt(obj)
                bodyPosition:Destroy()
            end
        end
    end
end
